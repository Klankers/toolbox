<!DOCTYPE html>
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#2D2D2D" />
  
  <title>Toolbox :: toolbox.steps.custom.variables.salinity</title>
  

  <link rel="icon" type="image/png" sizes="32x32" href="../../../../../_static/img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../../../_static/img/favicon-16x16.png">
  <link rel="index" title="Index" href="../../../../../genindex.html"/>

  <link rel="stylesheet" href="../../../../../_static/css/insegel.css"/>
  <link rel="stylesheet" href="../../../../../_static/css/custom.css"/>

  <script type="text/javascript" id="documentation_options" data-url_root="../../../../../" src="../../../../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../../../../_static/documentation_options.js"></script>
      <script type="text/javascript" src="../../../../../_static/doctools.js"></script>
      <script type="text/javascript" src="../../../../../_static/sphinx_highlight.js"></script>
      <script type="text/javascript" src="../../../../../_static/clipboard.min.js"></script>
      <script type="text/javascript" src="../../../../../_static/copybutton.js"></script>
      <script type="text/javascript" src="../../../../../_static/design-tabs.js"></script>
      <script type="text/javascript" src="../../../../../https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
  

  <script src="https://email.tl.fortawesome.com/c/eJxNjUEOgyAQAF8jR7Kw6wIHDh7sP1Cw2mgxgmn6-3JsMqc5zEQfE8dkxOY1KKMUOI3ACFKRJpSW2AAp7ontYIaxI6i7XPJVwyeVfCQ550Os3jLrGSNOLgbdAy6s0PBk2TFNjEbsfq31LB0OnX407pJa5v2faRadwSW63mn5KuLyR9j2tgx3zecanl-55R_-jjPs"></script> 
</head>

<body>
  <div id="insegel-container">
    <header>
      <div id="logo-container">
          
          <h1>Toolbox</h1>
          
      </div>
      <div id="project-container">
        
        <h1>Documentation</h1>
        
      </div>
    </header>

    <div id="content-container">

      <div id="main-content-container">
        <div id="main-content" role="main">
          
  <h1>Source code for toolbox.steps.custom.variables.salinity</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">toolbox.steps.base_step</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseStep</span><span class="p">,</span> <span class="n">register_step</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">toolbox.utils.diagnostics</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">diag</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">xarray</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">xr</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="kn">import</span> <span class="n">interpolate</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">gsw</span>


<div class="viewcode-block" id="running_average_nan">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.running_average_nan">[docs]</a>
<span class="k">def</span><span class="w"> </span><span class="nf">running_average_nan</span><span class="p">(</span><span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Estimate running average mean</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">window_size</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Window size must be odd for symmetry.&quot;</span><span class="p">)</span>

    <span class="n">pad_size</span> <span class="o">=</span> <span class="n">window_size</span> <span class="o">//</span> <span class="mi">2</span>  <span class="c1"># Symmetric padding</span>
    <span class="n">padded</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">pad_size</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;reflect&quot;</span><span class="p">)</span>  <span class="c1"># Edge handling</span>

    <span class="n">kernel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_size</span><span class="p">)</span>
    <span class="c1"># Compute weighted sums while ignoring NaNs</span>
    <span class="n">sum_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">padded</span><span class="p">),</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>
    <span class="n">count_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">padded</span><span class="p">),</span> <span class="n">kernel</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the moving average, handling NaNs properly</span>
    <span class="n">avg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">sum_vals</span><span class="p">,</span> <span class="n">count_vals</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="p">(</span><span class="n">count_vals</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">avg</span><span class="p">[</span><span class="n">count_vals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>  <span class="c1"># Set to NaN where all values were NaN</span>

    <span class="k">return</span> <span class="n">avg</span></div>



<span class="nd">@register_step</span>
<div class="viewcode-block" id="QCSalinity">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.QCSalinity">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QCSalinity</span><span class="p">(</span><span class="n">BaseStep</span><span class="p">):</span>
<div class="viewcode-block" id="QCSalinity.step_name">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.QCSalinity.step_name">[docs]</a>
    <span class="n">step_name</span> <span class="o">=</span> <span class="s2">&quot;QC: Salinity&quot;</span></div>
</div>



<span class="nd">@register_step</span>
<div class="viewcode-block" id="AdjustSalinity">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AdjustSalinity</span><span class="p">(</span><span class="n">BaseStep</span><span class="p">):</span>
<div class="viewcode-block" id="AdjustSalinity.step_name">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.step_name">[docs]</a>
    <span class="n">step_name</span> <span class="o">=</span> <span class="s2">&quot;ADJ: Salinity&quot;</span></div>


<div class="viewcode-block" id="AdjustSalinity.run">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.run">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply the thermal-lag correction for Salinity presented in Morrison et al 1994.</span>
<span class="sd">        The temperature is estimated inside the conductivity cell to estimate Salinity.</span>
<span class="sd">        This is based on eq.5 of Morrison et al. (1994), which doesn&#39;t require to know the sensitivity of temperature to conductivity (eq.2 of Morrison et al. 1994).</span>
<span class="sd">        No attempt is done yet to minimize the coefficients alpha/tau in T/S space, as in Morrison et al. (1994) or Garau et al. (2011).</span>
<span class="sd">        The fixed coefficients (alpha and tau) presented in Morrison et al. (1994) are used.</span>
<span class="sd">        These coefficients should be valid for pumped SeaBird CTsail as described in Woo (2019) by using their flow rate in the conductivity cell.</span>
<span class="sd">        This function should further be adapted to unpumped CTD by taking into account the glider velocity through the water based on the pitch angle or a hydrodynamic flight model.</span>

<span class="sd">        Woo, L.M. (2019). Delayed Mode QA/QC Best Practice Manual Version 2.0. Integrated Marine Observing System. DOI: 10.26198/5c997b5fdc9bd (http://dx.doi.org/ 10.26198/5c997b5fdc9bd).</span>

<span class="sd">        Parameters</span>
<span class="sd">        -----------</span>

<span class="sd">        self.tsr: xarray.Dataset with raw CTD dataset, which should contain:</span>
<span class="sd">            - time, sci_m_present_time, [numpy.datetime64]</span>
<span class="sd">            - PRES: pressure [dbar]</span>
<span class="sd">            - CNDC: conductivity [S/c]</span>
<span class="sd">            - TEMP: in-situ temperature [deg C]</span>
<span class="sd">            - LON: longitude</span>
<span class="sd">            - LAT: latitude</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">            Nil - serves on self in-place</span>
<span class="sd">                MUST APPLY self.data to self.context[&quot;data&quot;] to save the changes</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Running ADJ&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Run with diagnostics to determine if CTlag and thermal lag correction should be applied. Diagnostics: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="c1"># Check if the data is in the context</span>
        <span class="k">if</span> <span class="s2">&quot;data&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No data found in context. Please load data first.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Prepare the data for CNDC ADJ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span>
            <span class="n">prof_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span>
            <span class="n">unique_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prof_idx</span><span class="p">)</span>
            <span class="n">prof1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">unique_prof</span><span class="p">))</span>
            <span class="n">prof2</span> <span class="o">=</span> <span class="n">prof1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">unique_prof</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prof_idx</span> <span class="o">&gt;</span> <span class="n">prof1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">prof_idx</span> <span class="o">&lt;</span> <span class="n">prof2</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># Run functions based on params</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">generate_diagnostics</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;CTLag&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_CTlag</span><span class="p">()</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;thermal_lag_correction&quot;</span><span class="p">]:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">thermal_lag_correction</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span></div>


<div class="viewcode-block" id="AdjustSalinity.generate_diagnostics">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.generate_diagnostics">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">generate_diagnostics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Generating diagnostics...&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;CTLag&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">call_CTlag</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_CTLag</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;ThermalLag&quot;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">thermal_lag_correction</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_adj_profiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_tsr_raw</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">display_tsr_adj</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ioff</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Diagnostics generated.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdjustSalinity.thermal_lag_correction">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.thermal_lag_correction">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">thermal_lag_correction</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Check that call_CTlag was run first</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nonan</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="p">))</span>
        <span class="n">TEMP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="n">TIME_CTD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TIME_CTD</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="n">PRES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>

        <span class="c1"># Apply a 1-second interpolation to have a constant sampling rate (1 Hz)</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span>  <span class="c1"># Nyquist frequency</span>

        <span class="n">TIME_CTD_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">TIME_CTD</span> <span class="o">-</span> <span class="n">TIME_CTD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span>
        <span class="p">)</span>  <span class="c1"># Array of time difference in seconds from 1st measurement.</span>
        <span class="n">t_second</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">TIME_CTD_s</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">TIME_CTD_1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">TIME_CTD_s</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">TIME_CTD_s</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">TEMP_1s</span> <span class="o">=</span> <span class="n">t_second</span><span class="p">(</span><span class="n">TIME_CTD_1s</span><span class="p">)</span>

        <span class="c1"># Tau and alpha are the fixed coefficients of Morison94 for unpumped cell.</span>
        <span class="c1"># alpha: initial amplitude of the temperature error for a unit step change in ambient temperature [without unit].</span>
        <span class="c1"># tau = beta^-1: time constant of the error, the e-folding time of the temperature error [s].</span>
        <span class="c1"># The flow rate in the conductivity cell (spd) comes from Woo (2019).</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_offset</span> <span class="o">=</span> <span class="mf">0.0135</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alpha_slope</span> <span class="o">=</span> <span class="mf">0.0264</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_offset</span> <span class="o">=</span> <span class="mf">7.1499</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau_slope</span> <span class="o">=</span> <span class="mf">2.7858</span>
        <span class="n">spd</span> <span class="o">=</span> <span class="mf">0.4867</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau_slope</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">spd</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_offset</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">alpha_slope</span> <span class="o">/</span> <span class="n">spd</span>

        <span class="n">a</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">fn</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">fn</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">a</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span>

        <span class="n">dTemp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">TEMP_1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="n">TEMP_corrected_1s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">TEMP_1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">TEMP_corrected</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">TEMP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">0.0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">TEMP_1s</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">dTemp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">b</span> <span class="o">*</span> <span class="n">dTemp</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">TEMP_1s</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">TEMP_1s</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">TEMP_corrected_1s</span> <span class="o">=</span> <span class="n">TEMP_1s</span> <span class="o">-</span> <span class="n">dTemp</span>

        <span class="n">t_sampled</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span>
            <span class="n">TIME_CTD_1s</span><span class="p">,</span> <span class="n">TEMP_corrected_1s</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">TEMP_corrected</span> <span class="o">=</span> <span class="n">t_sampled</span><span class="p">(</span><span class="n">TIME_CTD_s</span><span class="p">)</span>

        <span class="c1"># adj variables do not exist if call_CTlag was not run before</span>
        <span class="n">varsi</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;DENSITY_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;SIGMA0_ADJ&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">varsi</span><span class="p">:</span>
            <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># Means call_CTlag was called before</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                    <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span>
                    <span class="n">coords</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">),</span>
                <span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vari</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">vari</span>
                    <span class="o">+</span> <span class="s2">&quot; with CT lag alignment and cell thermal mass correction (coefficients of Morrison et al. 1994)&quot;</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vari</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">vari</span>
                    <span class="o">+</span> <span class="s2">&quot; with cell thermal mass correction (coefficients of Morrison et al. 1994)&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Check that call_CTlag was run first</span>
        <span class="k">if</span> <span class="mi">1</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">CNDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">CNDC_ADJ</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">CNDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">CNDC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">SP_from_C</span><span class="p">(</span>
            <span class="mi">10</span> <span class="o">*</span> <span class="n">CNDC</span><span class="p">,</span> <span class="n">TEMP_corrected</span><span class="p">,</span> <span class="n">PRES</span>
        <span class="p">)</span>  <span class="c1"># OG1 is in [S/m] but should be in [mS/cm] for gsw.</span>
        <span class="n">SA</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">SA_from_SP</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="n">PRES</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">CT</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">CT_from_t</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span> <span class="n">PRES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;DENSITY_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">rho</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="n">PRES</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="s2">&quot;SIGMA0_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">sigma0</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">CT</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdjustSalinity.call_CTlag">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.call_CTlag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">call_CTlag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        For the full deployment, calculate the optimal conductivity time lag relative to temperature to reduce salinity spikes for each glider profile.</span>
<span class="sd">        If more than 300 profiles are present, the optimal lag is estimated every 10 profiles.</span>
<span class="sd">        Display the optimal conductivity time lag calculated for each profile, estimate the median of this lag, and apply this median lag to corrected variables (CNDC_ADJ/PSAL_ADJ).</span>
<span class="sd">        This correction should reduce salinity spikes that result from the misalignment between conductivity and temperature sensors and from the difference in sensor response times.</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self.tsr: xarray.Dataset with raw CTD dataset, which should contain:</span>
<span class="sd">            - PROFILE_NUMBER</span>
<span class="sd">            - TIME_CTD, sci_ctd41cp_timestamp, [numpy.datetime64]</span>
<span class="sd">            - PRES: pressure [dbar]</span>
<span class="sd">            - CNDC: conductivity [mS/cm]</span>
<span class="sd">            - TEMP: in-situ temperature [de C]</span>

<span class="sd">        windowLength: Window length over which the high-pass filter of conductivity is applied, 21 by default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.tsr: with tau and prof_i.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Calculate optimal conductivity time lag relative to temperature to reduce salinity spikes&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">prof_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int32&quot;</span><span class="p">)</span>
        <span class="c1"># Estimate the CT lag every profile or 10 profiles for more than 300 profiles.</span>
        <span class="n">d_prof</span> <span class="o">=</span> <span class="mi">10</span> <span class="k">if</span> <span class="n">prof_idx</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">300</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">prof_size</span> <span class="o">=</span> <span class="n">prof_idx</span><span class="p">[::</span><span class="n">d_prof</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="n">prof_size</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prof_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># Loop through every profile, keep the optimal CTlag for each profile, with the min standard dev of raw vs smoothed salinity.</span>
        <span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">prof_idx</span><span class="p">[::</span><span class="n">d_prof</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span> <span class="o">==</span> <span class="n">i</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">TIME_CTD</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;windowLength&quot;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prof_i</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_optimal_lag</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span></div>


<div class="viewcode-block" id="AdjustSalinity.compute_optimal_lag">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.compute_optimal_lag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">compute_optimal_lag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the optimal conductivity time lag relative to temperature to reduce salinity spikes for each glider profile.</span>
<span class="sd">        Mimimize the standard deviation of the difference between a lagged CNDC and a high-pass filtered CNDC.</span>
<span class="sd">        The optimal lag is returned. The lag is chosen from -2 to 2s every 0.1s.</span>
<span class="sd">        This correction should reduce salinity spikes that result from the misalignment between conductivity and temperature sensors and from the difference in sensor response times.</span>
<span class="sd">        This correction is described in Woo (2019) but the mimimization is done between salinity and high-pass filtered salinity (as done by RBR, https://bitbucket.org/rbr/pyrsktools/src/master/pyrsktools) instead of comparing downcast vs upcast.</span>

<span class="sd">        Woo, L.M. (2019). Delayed Mode QA/QC Best Practice Manual Version 2.0. Integrated Marine Observing System. DOI: 10.26198/5c997b5fdc9bd (http://dx.doi.org/ 10.26198/5c997b5fdc9bd).</span>


<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        self.tsr: xarray.Dataset with raw CTD dataset for one single profile, which should contain:</span>
<span class="sd">            - TIME_CTD, sci_ctd41cp_timestamp, [numpy.datetime64]</span>
<span class="sd">            - PRES: pressure [dbar]</span>
<span class="sd">            - CNDC: conductivity [S/m]</span>
<span class="sd">            - TEMP: in-situ temperature [de C]</span>

<span class="sd">        windowLength: Window length over which the high-pass filter of conductivity is applied, 21 by default.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        self.tsr: with lags.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">idx</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="p">[</span><span class="s2">&quot;CNDC&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">TIME_CTD</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">TIME_CTD</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">CNDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">CNDC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">TEMP</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
        <span class="n">PRES</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr_i</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

        <span class="n">TIME_CTD_s</span> <span class="o">=</span> <span class="p">(</span><span class="n">TIME_CTD</span> <span class="o">-</span> <span class="n">TIME_CTD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span>
            <span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span>
        <span class="p">)</span>  <span class="c1"># Array of time difference in seconds from 1st measurement.</span>

        <span class="n">shft</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">TIME_CTD_s</span><span class="p">,</span> <span class="n">CNDC</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">lags</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
        <span class="n">runningStdDiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">lags</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lags</span><span class="p">):</span>
            <span class="n">cShift</span> <span class="o">=</span> <span class="n">shft</span><span class="p">(</span><span class="n">TIME_CTD_s</span> <span class="o">+</span> <span class="n">l</span><span class="p">)</span>
            <span class="n">PSAL</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">conversions</span><span class="o">.</span><span class="n">SP_from_C</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">cShift</span><span class="p">,</span> <span class="n">TEMP</span><span class="p">,</span> <span class="n">PRES</span><span class="p">)</span>
            <span class="n">PSAL_Smooth</span> <span class="o">=</span> <span class="n">running_average_nan</span><span class="p">(</span><span class="n">PSAL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parameters</span><span class="p">[</span><span class="s2">&quot;windowLength&quot;</span><span class="p">])</span>
            <span class="n">PSAL_Diff</span> <span class="o">=</span> <span class="n">PSAL</span> <span class="o">-</span> <span class="n">PSAL_Smooth</span>
            <span class="n">runningStdDiff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanstd</span><span class="p">(</span><span class="n">PSAL_Diff</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lags</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">runningStdDiff</span><span class="p">)]</span></div>


<div class="viewcode-block" id="AdjustSalinity.display_CTLag">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.display_CTLag">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_CTLag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Display optimal CTlag for each profile</span>
        <span class="n">prof_min</span><span class="p">,</span> <span class="n">prof_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_i</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_i</span><span class="p">)</span>
        <span class="n">tau_median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
            <span class="p">[</span><span class="n">prof_min</span><span class="p">,</span> <span class="n">prof_max</span><span class="p">],</span>
            <span class="p">[</span><span class="n">tau_median</span><span class="p">,</span> <span class="n">tau_median</span><span class="p">],</span>
            <span class="n">c</span><span class="o">=</span><span class="s2">&quot;indianred&quot;</span><span class="p">,</span>
            <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span>
            <span class="n">linewidth</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">label</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Median CTlag: </span><span class="si">{</span><span class="n">tau_median</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">s&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">prof_min</span><span class="p">,</span> <span class="n">prof_max</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prof_i</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">},</span> <span class="n">labelcolor</span><span class="o">=</span><span class="s2">&quot;indianred&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;--&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">([</span><span class="n">prof_min</span><span class="p">,</span> <span class="n">prof_max</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span>
            <span class="s2">&quot;CTlag [s]</span><span class="se">\n</span><span class="s2"> &lt; 0: delay Cond by CTlag</span><span class="se">\n</span><span class="s2"> &gt; 0: advance Cond by CTlag&quot;</span><span class="p">,</span>
            <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Profile Index&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="c1"># Save corrected salinity/density after applying the optimal CTlag on conductivity (this conductivity is not saved, only used to reduce salinity noise).</span>
        <span class="n">nonan</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">CNDC</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
        <span class="n">TIME_CTD_s</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TIME_CTD</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TIME_CTD</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span>
        <span class="n">CNDC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">CNDC</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="n">shft</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">TIME_CTD_s</span><span class="p">,</span> <span class="n">CNDC</span><span class="p">,</span> <span class="n">bounds_error</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">varsi</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;CNDC_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;DENSITY_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;SIGMA0_ADJ&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">vari</span> <span class="ow">in</span> <span class="n">varsi</span><span class="p">:</span>
            <span class="n">dim_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># typically &#39;N_MEASUREMENTS&#39;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">DataArray</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="n">dim_name</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">),</span>
                <span class="n">dims</span><span class="o">=</span><span class="p">[</span><span class="n">dim_name</span><span class="p">],</span>
                <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="n">dim_name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">time</span><span class="p">},</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">vari</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]]</span><span class="o">.</span><span class="n">attrs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">vari</span><span class="p">]</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;comment&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vari</span> <span class="o">+</span> <span class="s2">&quot; with CT lag alignment&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;CNDC_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">shft</span><span class="p">(</span><span class="n">TIME_CTD_s</span> <span class="o">+</span> <span class="n">tau_median</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">conversions</span><span class="o">.</span><span class="n">SP_from_C</span><span class="p">(</span>
            <span class="mi">10</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;CNDC_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">SA</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">SA_from_SP</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LON</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">LAT</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">CT</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">CT_from_t</span><span class="p">(</span>
            <span class="n">SA</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;DENSITY_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">rho</span><span class="p">(</span>
            <span class="n">SA</span><span class="p">,</span> <span class="n">CT</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PRES</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&quot;SIGMA0_ADJ&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonan</span><span class="p">]</span> <span class="o">=</span> <span class="n">gsw</span><span class="o">.</span><span class="n">sigma0</span><span class="p">(</span><span class="n">SA</span><span class="p">,</span> <span class="n">CT</span><span class="p">)</span></div>


<div class="viewcode-block" id="AdjustSalinity.display_adj_profiles">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.display_adj_profiles">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_adj_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display profiles for ~20 mid profiles of:</span>
<span class="sd">            (1) PSAL: raw salinity</span>
<span class="sd">            (2) PSAL_ADJ: salinity corrected from CTlag</span>
<span class="sd">            (3) PSAL_ADJ: salinity with the thermal lag correction</span>
<span class="sd">            (4) difference between raw and ADJ (CTlag + thermal lag correction) salinity and temperature</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define a subset of ~20 profiles in the mid-mission</span>
        <span class="n">prof_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span>
        <span class="n">unique_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prof_idx</span><span class="p">)</span>
        <span class="n">prof1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">unique_prof</span><span class="p">))</span>
        <span class="n">prof2</span> <span class="o">=</span> <span class="n">prof1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">unique_prof</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="p">(</span><span class="n">prof_idx</span> <span class="o">&gt;</span> <span class="n">prof1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">prof_idx</span> <span class="o">&lt;</span> <span class="n">prof2</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

        <span class="n">nonna</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="p">)</span>
        <span class="n">idx_u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">profile_direction</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonna</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># Ups</span>
        <span class="n">idx_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">profile_direction</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">nonna</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>  <span class="c1"># Downs</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">ncols</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Function to plot data for each category (downs and ups)</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">plot_profiles</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
            <span class="p">):</span>
                <span class="n">prof_id</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>

                <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="n">color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL_ADJ</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="n">color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL_ADJ</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="n">color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>

                <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL_ADJ</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">]</span>
                    <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="n">color</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">labels</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">color</span> <span class="o">==</span> <span class="s2">&quot;grey&quot;</span><span class="p">:</span>
                <span class="n">ax3</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">twiny</span><span class="p">()</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">TEMP</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">prof_id</span><span class="p">],</span>
                    <span class="n">c</span><span class="o">=</span><span class="s2">&quot;k&quot;</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Temperature&quot;</span> <span class="k">if</span> <span class="n">ct</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">ax3</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Temperature [$^{\circ}$C]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">plot_profiles</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">,</span>
            <span class="n">idx_d</span><span class="p">,</span>
            <span class="s2">&quot;grey&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;downs&quot;</span><span class="p">,</span> <span class="s2">&quot;downs (CTlag)&quot;</span><span class="p">,</span> <span class="s2">&quot;downs (thermal mass)&quot;</span><span class="p">,</span> <span class="s2">&quot;downs (ADJ - raw)&quot;</span><span class="p">],</span>
        <span class="p">)</span>
        <span class="n">plot_profiles</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">,</span>
            <span class="n">idx_u</span><span class="p">,</span>
            <span class="s2">&quot;blue&quot;</span><span class="p">,</span>
            <span class="p">[</span><span class="s2">&quot;ups&quot;</span><span class="p">,</span> <span class="s2">&quot;ups (CTlag)&quot;</span><span class="p">,</span> <span class="s2">&quot;ups (thermal mass)&quot;</span><span class="p">,</span> <span class="s2">&quot;ups (ADJ - raw)&quot;</span><span class="p">],</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">grid</span><span class="p">()</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">prop</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;weight&quot;</span><span class="p">:</span> <span class="s2">&quot;bold&quot;</span><span class="p">,</span> <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="mi">12</span><span class="p">})</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span>
                <span class="sa">r</span><span class="s2">&quot;$\Delta$ PSAL [psu]&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">3</span> <span class="k">else</span> <span class="s2">&quot;PSAL [psu]&quot;</span><span class="p">,</span>
                <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.02</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.02</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">minmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL_ADJ</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx_u</span><span class="p">]</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx_u</span><span class="p">]</span>
                    <span class="p">),</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL_ADJ</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx_d</span><span class="p">]</span>
                        <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">PSAL</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">idx_d</span><span class="p">]</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="n">minmax</span><span class="p">,</span> <span class="n">minmax</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Depth [m]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span>
                <span class="s2">&quot;plots/3_adj_profiles&quot;</span><span class="p">,</span>
                <span class="n">bbox_inches</span><span class="o">=</span><span class="s2">&quot;tight&quot;</span><span class="p">,</span>
                <span class="n">pad_inches</span><span class="o">=</span><span class="mf">0.02</span><span class="p">,</span>
                <span class="n">dpi</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span>
                <span class="n">facecolor</span><span class="o">=</span><span class="s2">&quot;white&quot;</span><span class="p">,</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="AdjustSalinity.display_tsr_raw">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.display_tsr_raw">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_tsr_raw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display for ~20 mid profiles of:</span>
<span class="sd">            (1) TEMP: in situ temperature</span>
<span class="sd">            (2) PSAL: raw salinity</span>
<span class="sd">            (3) DENSITY: density</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;TEMP&quot;</span><span class="p">,</span> <span class="s2">&quot;PSAL&quot;</span><span class="p">,</span> <span class="s2">&quot;DENSITY&quot;</span><span class="p">]</span>
        <span class="n">units</span> <span class="o">=</span> <span class="p">[</span><span class="sa">r</span><span class="s2">&quot; [$^{\circ}$C]&quot;</span><span class="p">,</span> <span class="s2">&quot; [psu]&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot; [kg/m$^3$]&quot;</span><span class="p">]</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;RdYlBu_r&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="s2">&quot;Blues&quot;</span><span class="p">]</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="c1"># Loop through variables to create scatter plots</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1000</span> <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;DENSITY&quot;</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>  <span class="c1"># Adjust density</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

            <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">,</span>
                <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                <span class="n">cmap</span><span class="o">=</span><span class="n">colormaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="n">units</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Depth [m]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>


<div class="viewcode-block" id="AdjustSalinity.display_tsr_adj">
<a class="viewcode-back" href="../../../../../api/toolbox/steps/custom/variables/salinity/index.html#toolbox.steps.custom.variables.salinity.AdjustSalinity.display_tsr_adj">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">display_tsr_adj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Display for ~20 mid profiles (all=0) or the entire section (all=1) of:</span>
<span class="sd">            (1) PSAL: raw salinity</span>
<span class="sd">            (2) PSAL_ADJ: ADJ salinity</span>
<span class="sd">            (3) raw - ADJ salinity</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">prof_idx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="o">.</span><span class="n">PROFILE_NUMBER</span>
        <span class="n">unique_prof</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">prof_idx</span><span class="p">)</span>
        <span class="n">prof1</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">unique_prof</span><span class="p">))</span>
        <span class="n">prof2</span> <span class="o">=</span> <span class="n">prof1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">unique_prof</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">20</span><span class="p">]))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">prof_idx</span> <span class="o">&gt;</span> <span class="n">prof1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">prof_idx</span> <span class="o">&lt;</span> <span class="n">prof2</span><span class="p">),</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">all</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># Display the entire deployment</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsr</span>

        <span class="n">variables</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;PSAL&quot;</span><span class="p">,</span> <span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">]</span>
        <span class="n">colormaps</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="s2">&quot;RdBu_r&quot;</span><span class="p">]</span>
        <span class="n">cs</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span>
            <span class="n">nrows</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span> <span class="k">if</span> <span class="nb">all</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="c1"># Loop through variables to create scatter plots</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">variables</span><span class="p">):</span>
            <span class="n">data</span> <span class="o">=</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="s2">&quot;PSAL&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="s2">&quot;PSAL_ADJ&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;diff&quot;</span>
                <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="p">[</span><span class="n">var</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
            <span class="n">vmin</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>
            <span class="n">vmax</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="p">(</span><span class="n">vmax</span> <span class="o">-</span> <span class="n">vmin</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">colormaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">vmin</span><span class="o">=-</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vmax</span><span class="p">)]),</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="mf">0.8</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vmin</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vmax</span><span class="p">)]),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">time</span><span class="p">,</span>
                    <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">tsrs</span><span class="o">.</span><span class="n">DEPTH</span><span class="p">,</span>
                    <span class="n">c</span><span class="o">=</span><span class="n">data</span><span class="p">,</span>
                    <span class="n">cmap</span><span class="o">=</span><span class="n">colormaps</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                    <span class="n">vmin</span><span class="o">=</span><span class="n">vmin</span><span class="p">,</span>
                    <span class="n">vmax</span><span class="o">=</span><span class="n">vmax</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="s2">&quot;PSAL - PSAL_ADJ [psu]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">var</span> <span class="o">+</span> <span class="s2">&quot; [psu]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Depth [m]&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>

        <span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;TIME&quot;</span><span class="p">,</span> <span class="n">fontweight</span><span class="o">=</span><span class="s2">&quot;bold&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span></div>
</div>

</pre></div>

        </div>
      </div>

      <div id="side-menu-container">

        <div id="search" role="search">
        <form id="rtd-search-form" class="wy-form" action="../../../../../search.html" method="get">
            <input type="text" name="q" placeholder="Search..." />
            <input type="hidden" name="check_keywords" value="yes" />
            <input type="hidden" name="area" value="default" />
        </form>
</div>

        <div id="side-menu" role="navigation">

          
  
    
  
  
    <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../../../api/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../../../api/toolbox/index.html">toolbox</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../../../api/toolbox/index.html#submodules">Submodules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../api/toolbox/index.html#attributes">Attributes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../../../api/toolbox/index.html#package-contents">Package Contents</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  


        </div>

        

      </div>

    </div>

<footer>
    <div id="footer-info">
        <ul id="build-details">
            

            

            
        </ul>

        
            <div id="copyright">
                &copy; 2025, Adam Ward, National Oceanography Centre
            </div>
        

        <div id="credit">
            created with <a href="http://sphinx-doc.org/">Sphinx</a> and <a href="https://github.com/Autophagy/insegel">Insegel</a>

        </div>
    </div>

    <a id="menu-toggle" class="fa fa-bars" aria-hidden="true"></a>

    <script type="text/javascript">
      $("#menu-toggle").click(function() {
        $("#menu-toggle").toggleClass("toggled");
        $("#side-menu-container").slideToggle(300);
      });
    </script>

</footer> 

</div>

</body>
</html>